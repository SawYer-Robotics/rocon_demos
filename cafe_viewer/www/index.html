<!DOCTYPE html>
<html>
  <head>
  <meta charset="UTF-8">
    <title>Rocon - Real Robot Show Viewer</title>

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- ROS related -->
    <script type="text/javascript" src="js/easeljs/easeljs.js"></script>
    <script type="text/javascript" src="js/eventemitter2/eventemitter2.js"></script>
    <script type="text/javascript" src="js/ros/roslib.js"></script>
    <script type="text/javascript" src="js/ros/ros2d.js"></script>
    <script type="text/javascript" src="js/ros/nav2d.js"></script>
    <script type="text/javascript" src="js/ros/worldlib.js"></script>
    <script type="text/javascript" src="js/annotator/annotator.js"></script>
    <script type="text/javascript" src="js/annotator/circle.js"></script>
    <script type="text/javascript" src="js/region_viz/regionviz.js"></script>
    <script type="text/javascript" src="js/region_viz/circle.js"></script>
    <script type="text/javascript" src="js/region_viz/alvar_ar.js"></script>
    <script type="text/javascript" src="js/model/Robot.js"></script>
    <script type="text/javascript" src="js/model/OccupancyGridSrvClient.js"></script>

    <!-- Le styles -->
    <link href="css/bootstrap.css" rel="stylesheet"></link>
    <link href="css/bootstrap-button.css" rel="stylesheet"></link>
    <style type="text/css">
      body {
        padding-top: 60px;
        padding-bottom: 40px;
      }
      .sidebar-nav {
        padding: 9px 0;
      }
      .sd-status-bar{
        margin:10px;
        font-size:27px;
        color:white;
      }
      .sd-logo{
        height:47px;
        width:150px;
        float:right;
      }

      @media (max-width: 980px) {
        /* Enable use of floated navbar text */
        .navbar-text.pull-right {
          float: none;
          padding-left: 5px;
          padding-right: 5px;
        }
      }
    </style>

    <script src="js/jquery.js"></script>
    <script src="js/bootstrap/bootstrap.js"></script>
    <script src="js/bootstrap/bootstrap-button.js"></script>


    <link href="css/bootstrap-responsive.css" rel="stylesheet"></link>
    <script type="text/javascript" src="http://robotics-in-concert.github.io/rocon_tools/js/hydro/interactions.js"></script>

    <script src="js/add_orderlist.js"></script>

    <script type="text/javascript">
      var ros = new ROSLIB.Ros();
      var defaultUrL = rocon_interactions.rosbridge_uri;
      var robot1 = rocon_interactions.parameters['robot1'];
      var viewer;
      var gridClient;
      var circle_region_poller;
      var ar_region_poller;
      var annotator;

      $().ready(function(e) {
        initHeader();
        initViewer();
        initStatusViewer();
        var nw = $('#nav-wrapper');
        nw.css('margin-top','20pt');
      });

      function initHeader()
      {
        settingROSCallbacks();
        ros.connect(defaultUrL);
        $('#focusedInput').val(''+defaultUrL);
      }

      function initViewer() {

        viewer = createViewer();
        gridClient = addMap(viewer);
        addRegionViz(viewer,gridClient);
        addNavigators(viewer,gridClient);
      }

      function createViewer() {
        div = $('#view');
        div.css('margin-top','20pt');

        var width = div.width();
        var half_window = $(document).height() -200;
        var height = half_window;// < 200?200:half_window;

        viewer = new ROS2D.Viewer({
          divID : 'view',
          width: width,
          height: height,
          background: '#DDDDDD'
        });

        viewer.scene.mouseEnabled = true;
        createjs.Touch.enable(viewer.scene);
        

        $(window).resize(function(e) {
          var half_window = $(document).height()-200;
          var height = half_window;// < 200?200:half_window;

          viewer.resizeCanvas(width,height);
          viewer.scaleToDimensions(gridClient.currentGrid.width, gridClient.currentGrid.height);
        });

        return viewer;
      }

      function addMap(viewer) {
        var continuous = false;
        var map_topic = rocon_interactions.remappings['map'] || 'map';
        gridClient = new ROS2D.OccupancyGridClient({
          ros : ros,
          topic : map_topic,
          rootObject : viewer.scene,
        });

        // Scale the canvas to fit to the map
        gridClient.on('change', function(map_origin) {
          viewer.scaleToDimensions(gridClient.currentGrid.width, gridClient.currentGrid.height);
        });
        return gridClient;
      }

      function addNavigators(viewer,gridClient) {

        var robot1_name = robot1;
        var robot1_pose_topic = '/' + robot1 + '/robot_pose';
        
        gridClient.on('change', function(map_origin) {
          var robot1 = new ROS2D.Robot({
            ros: ros,
            map_origin : map_origin,
            name       : robot1_name,
            size       : 20,
            topicName  : robot1_pose_topic, 
            topicType  : 'geometry_msgs/PoseStamped',
            fillColor  : createjs.Graphics.getRGB(255,64,128,0.66),
            rootObject : viewer.scene
          });

        });
      }

      function addRegionViz(viewer,gridClient)
      {
        var table_topic = rocon_interactions.remappings['tables'] || 'tables';
        var ar_marker_topic = rocon_interactions.remappings['ar_markers'] || 'ar_markers';
        gridClient.on('change', function(map_origin) {
          circle_region_poller = new REGIONVIZ.Circle({
            ros: ros,
            map_origin : map_origin,
            rootObject : viewer.scene,
            tableTopicName : table_topic,
            //orderTopicName : order_topic
          });

          ar_region_poller = new REGIONVIZ.AlvarAR({
            ros: ros,
            map_origin : map_origin,
            rootObject : viewer.scene,
            topicName : ar_marker_topic
          });

        });
      }

      function settingROSCallbacks(){
        ros.on('connection',function() {
          console.log("Connected");
          // subscribe to order list
        }
        );
        ros.on('error',function(e) {
          console.log("Error!",e);
        }
        );
                                                     
        ros.on('close',function() {
          console.log("Connection Close!");
          $('#focusedInput').val('Disconnected');
        }
        );
      }

      function initStatusViewer(){
        //topic name
        var diagnostic_sub_topic = "diagnostics_agg";
        var robot_status_sub_topic = "robot_status";
        //topic type
        var diagnostic_sub_topic_type = "diagnostic_msgs/DiagnosticArray";
        var robot_status_sub_topic_type = "std_msgs/String";

        if(diagnostic_sub_topic in rocon_interactions.remappings)
          diagnostic_sub_topic = rocon_interactions.remappings[diagnostic_sub_topic];
        if(robot_status_sub_topic in rocon_interactions.remappings)
          robot_status_sub_topic = rocon_interactions.remappings[robot_status_sub_topic];

        var diagnostic_listener = new ROSLIB.Topic({
          ros : ros,
          name : diagnostic_sub_topic,
          messageType: diagnostic_sub_topic_type
        });
        diagnostic_listener.subscribe(processDiagnosticUpdate);

        var robot_status_listener = new ROSLIB.Topic({
          ros : ros,
          name : robot_status_sub_topic,
          messageType: robot_status_sub_topic_type
        });
        robot_status_listener.subscribe(processRobotStatusUpdate);
      }

      function processDiagnosticUpdate(data){
        for (var i = data.status.length - 1; i >= 0; i--) {
          var name = data.status[i].name;
          if(name === "/Power System/Laptop Battery"){
              var percent = getBattPecent(data.status[i].values);
              setBattPecent('.sd-laptop-batt-status',percent);
          }
          else if(name === "/Power System/Battery"){
              var percent = getBattPecent(data.status[i].values);
              setBattPecent('.sd-robot-batt-status',percent);
          }
        }
        
      };

      function setBattPecent(obj, data){
          var text = $(obj).text();
          $(obj).text(text.split(':')[0]+': ' + data+' %');
      }

      function getBattPecent(data){
          var percent = '-1';
          var charge = -1;
          var capacity = -1;
          for (var i = 0; i < data.length; i++) {
            var key = data[i].key;
            if(key === 'Charge (Ah)'){
               charge = data[i].value;
            }
            else if(key === 'Capacity (Ah)'){
               capacity = data[i].value;
            }
          };
          if( charge === -1 || capacity === -1){
            percent = -1;  
          }
          else{
            percent = 100 * charge / capacity;
          } 
          return percent.toFixed(2);
      };

    </script>
  </head>
  <body>
    <!-- Header -->
    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-fluid ">
          <ul class="nav nav-pills ">
            <li class="disabled sd-robot-status sd-status-bar">Robot status : Initialization</li>
            <li class="disabled sd-robot-batt-status sd-status-bar">Robot batt. : -1%</li>
            <li class="disabled sd-laptop-batt-status sd-status-bar" >Laptop batt. : -1%</li>
          </ul>
          <img class="sd-logo" src="img/rocon_logo.png"></img> 
        </div>
      </div>
    </div>

    <!-- Visualizer -->
    <div class="container-fluid">
      <div class="row-fluid">
        <div class="span12" id="view"></div>
      </div>
    </div>
    <hr/>
    <footer>
      <img style="width:90px; height:25px;" src="img/yujin_logo.jpg"></img>
      &copy 2014
    </footer>
  </body>
</html>
